<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App de Inspe√ß√£o Sensitiva de Equipamentos</title>
    <!-- Incluindo o Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importando um √≠cone para a aba do navegador -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">
    <style>
        /* Estilos personalizados para melhorar a apar√™ncia */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .status-ok { background-color: #22c55e; color: white; }
        .status-atencao { background-color: #f59e0b; color: white; }
        .status-critico { background-color: #ef4444; color: white; }
        .modal-content {
            max-height: 80vh;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Cabe√ßalho -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">üìã App de Inspe√ß√£o Sensitiva</h1>
            <p class="text-gray-600 mt-2">Registre e acompanhe as inspe√ß√µes de seus equipamentos industriais.</p>
        </header>

        <!-- Grade principal: formul√°rio √† esquerda, hist√≥rico √† direita -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            
            <!-- Coluna do Formul√°rio de Inspe√ß√£o -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg self-start">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-4">Nova Inspe√ß√£o</h2>
                <form id="inspection-form">
                    <!-- Sele√ß√£o de Equipamento -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label for="equipment-select" class="block text-sm font-medium text-gray-700">Selecione o Equipamento</label>
                            <button type="button" id="manage-equipment-btn" class="text-sm text-blue-600 hover:underline">Gerenciar</button>
                        </div>
                        <select id="equipment-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <!-- Op√ß√µes de equipamento carregadas via JS -->
                        </select>
                    </div>

                    <!-- Checklist de Inspe√ß√£o -->
                    <div id="checklist" class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-800">Checklist Sensitivo</h3>
                        
                        <div class="p-4 border rounded-lg bg-gray-50"><label class="block text-md font-semibold text-gray-700 mb-3">1. N√≠vel de Vibra√ß√£o</label><div class="flex flex-wrap gap-4" data-item="vibra√ß√£o"><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="vibra√ß√£o" value="OK" class="form-radio text-green-500 h-5 w-5"> <span class="text-gray-700">OK</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="vibra√ß√£o" value="Aten√ß√£o" class="form-radio text-yellow-500 h-5 w-5"> <span class="text-gray-700">Aten√ß√£o</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="vibra√ß√£o" value="Cr√≠tico" class="form-radio text-red-500 h-5 w-5"> <span class="text-gray-700">Cr√≠tico</span></label></div></div>
                        <div class="p-4 border rounded-lg bg-gray-50"><label class="block text-md font-semibold text-gray-700 mb-3">2. N√≠vel de Ru√≠do</label><div class="flex flex-wrap gap-4" data-item="ru√≠do"><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="ru√≠do" value="OK" class="form-radio text-green-500 h-5 w-5"> <span class="text-gray-700">OK</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="ru√≠do" value="Aten√ß√£o" class="form-radio text-yellow-500 h-5 w-5"> <span class="text-gray-700">Aten√ß√£o</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="ru√≠do" value="Cr√≠tico" class="form-radio text-red-500 h-5 w-5"> <span class="text-gray-700">Cr√≠tico</span></label></div></div>
                        <div class="p-4 border rounded-lg bg-gray-50"><label class="block text-md font-semibold text-gray-700 mb-3">3. Temperatura (Tato)</label><div class="flex flex-wrap gap-4" data-item="temperatura"><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="temperatura" value="OK" class="form-radio text-green-500 h-5 w-5"> <span class="text-gray-700">OK</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="temperatura" value="Aten√ß√£o" class="form-radio text-yellow-500 h-5 w-5"> <span class="text-gray-700">Aten√ß√£o</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="temperatura" value="Cr√≠tico" class="form-radio text-red-500 h-5 w-5"> <span class="text-gray-700">Cr√≠tico</span></label></div></div>
                        <div class="p-4 border rounded-lg bg-gray-50"><label class="block text-md font-semibold text-gray-700 mb-3">4. Fixa√ß√£o</label><div class="flex flex-wrap gap-4" data-item="fixa√ß√£o"><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="fixa√ß√£o" value="OK" class="form-radio text-green-500 h-5 w-5"> <span class="text-gray-700">OK</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="fixa√ß√£o" value="Aten√ß√£o" class="form-radio text-yellow-500 h-5 w-5"> <span class="text-gray-700">Aten√ß√£o</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="fixa√ß√£o" value="Cr√≠tico" class="form-radio text-red-500 h-5 w-5"> <span class="text-gray-700">Cr√≠tico</span></label></div></div>
                        <div class="p-4 border rounded-lg bg-gray-50"><label class="block text-md font-semibold text-gray-700 mb-3">5. Limpeza</label><div class="flex flex-wrap gap-4" data-item="limpeza"><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="limpeza" value="OK" class="form-radio text-green-500 h-5 w-5"> <span class="text-gray-700">OK</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="limpeza" value="Aten√ß√£o" class="form-radio text-yellow-500 h-5 w-5"> <span class="text-gray-700">Aten√ß√£o</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="limpeza" value="Cr√≠tico" class="form-radio text-red-500 h-5 w-5"> <span class="text-gray-700">Cr√≠tico</span></label></div></div>
                        
                        <!-- Itens de Vazamento -->
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-4">
                            <h4 class="block text-md font-semibold text-gray-700">6. Vazamentos</h4>
                            <div data-item="vazamento_geral" class="space-y-2"><label class="text-gray-700 font-medium block">Status Geral:</label><div class="flex flex-wrap gap-x-4 gap-y-2"><label class="flex items-center space-x-1 cursor-pointer"><input type="radio" name="vazamento_geral" value="OK" class="form-radio"><span>Sem Vazamento (OK)</span></label><label class="flex items-center space-x-1 cursor-pointer"><input type="radio" name="vazamento_geral" value="Verificar" class="form-radio"><span>Com Vazamento (Verificar abaixo)</span></label></div></div>
                            <hr>
                            <div id="vazamento-details-container" class="space-y-4 transition-opacity">
                                <div data-item="tipo_fluido"><label class="text-gray-700 font-medium mb-2 block">Tipo de Fluido:</label><div class="flex flex-wrap gap-x-4 gap-y-2"><label class="flex items-center space-x-1"><input type="radio" name="tipo_fluido" value="√Ågua" class="form-radio"><span>√Ågua</span></label><label class="flex items-center space-x-1"><input type="radio" name="tipo_fluido" value="√ìleo" class="form-radio"><span>√ìleo</span></label><label class="flex items-center space-x-1"><input type="radio" name="tipo_fluido" value="Vapor" class="form-radio"><span>Vapor</span></label><label class="flex items-center space-x-1"><input type="radio" name="tipo_fluido" value="Outro" class="form-radio"><span>Outro</span></label></div></div>
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2" data-item="vazamento_gaxeta"><label class="text-gray-700">Gaxeta:</label><div class="flex gap-3 flex-shrink-0"><label class="flex items-center space-x-1"><input type="radio" name="vazamento_gaxeta" value="OK" class="form-radio text-green-500"><span>OK</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_gaxeta" value="Aten√ß√£o" class="form-radio text-yellow-500"><span>Aten√ß√£o</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_gaxeta" value="Cr√≠tico" class="form-radio text-red-500"><span>Cr√≠tico</span></label></div></div>
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2" data-item="vazamento_selo"><label class="text-gray-700">Selo Mec√¢nico:</label><div class="flex gap-3 flex-shrink-0"><label class="flex items-center space-x-1"><input type="radio" name="vazamento_selo" value="OK" class="form-radio text-green-500"><span>OK</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_selo" value="Aten√ß√£o" class="form-radio text-yellow-500"><span>Aten√ß√£o</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_selo" value="Cr√≠tico" class="form-radio text-red-500"><span>Cr√≠tico</span></label></div></div>
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2" data-item="vazamento_tubula√ß√£o"><label class="text-gray-700">Tubula√ß√£o:</label><div class="flex gap-3 flex-shrink-0"><label class="flex items-center space-x-1"><input type="radio" name="vazamento_tubula√ß√£o" value="OK" class="form-radio text-green-500"><span>OK</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_tubula√ß√£o" value="Aten√ß√£o" class="form-radio text-yellow-500"><span>Aten√ß√£o</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_tubula√ß√£o" value="Cr√≠tico" class="form-radio text-red-500"><span>Cr√≠tico</span></label></div></div>
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2" data-item="vazamento_juntas"><label class="text-gray-700">Juntas:</label><div class="flex gap-3 flex-shrink-0"><label class="flex items-center space-x-1"><input type="radio" name="vazamento_juntas" value="OK" class="form-radio text-green-500"><span>OK</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_juntas" value="Aten√ß√£o" class="form-radio text-yellow-500"><span>Aten√ß√£o</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_juntas" value="Cr√≠tico" class="form-radio text-red-500"><span>Cr√≠tico</span></label></div></div>
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2" data-item="vazamento_flanges"><label class="text-gray-700">Flanges:</label><div class="flex gap-3 flex-shrink-0"><label class="flex items-center space-x-1"><input type="radio" name="vazamento_flanges" value="OK" class="form-radio text-green-500"><span>OK</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_flanges" value="Aten√ß√£o" class="form-radio text-yellow-500"><span>Aten√ß√£o</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_flanges" value="Cr√≠tico" class="form-radio text-red-500"><span>Cr√≠tico</span></label></div></div>
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2" data-item="vazamento_conex√µes"><label class="text-gray-700">Conex√µes:</label><div class="flex gap-3 flex-shrink-0"><label class="flex items-center space-x-1"><input type="radio" name="vazamento_conex√µes" value="OK" class="form-radio text-green-500"><span>OK</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_conex√µes" value="Aten√ß√£o" class="form-radio text-yellow-500"><span>Aten√ß√£o</span></label><label class="flex items-center space-x-1"><input type="radio" name="vazamento_conex√µes" value="Cr√≠tico" class="form-radio text-red-500"><span>Cr√≠tico</span></label></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Captura de Imagem -->
                    <div class="mt-6">
                        <label for="camera-input" class="block text-sm font-medium text-gray-700 mb-2">Tirar Foto ou Anexar Arquivo</label>
                        <input type="file" id="camera-input" accept="image/*" capture="environment" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                        <p class="text-xs text-gray-500 mt-2">Em celulares, esta op√ß√£o deve abrir a c√¢mera. No computador, abrir√° um seletor de arquivos.</p>
                        <img id="image-preview" class="mt-4 rounded-lg shadow-md hidden max-w-full h-auto" src="" alt="Pr√©-visualiza√ß√£o da imagem">
                    </div>

                    <!-- Campo de Observa√ß√µes -->
                    <div class="mt-6">
                        <label for="observations" class="block text-sm font-medium text-gray-700 mb-2">Observa√ß√µes Adicionais</label>
                        <textarea id="observations" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Descreva qualquer anomalia ou detalhe importante..."></textarea>
                    </div>

                    <!-- Bot√£o de Envio -->
                    <div class="mt-8 text-center">
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                            Salvar Inspe√ß√£o
                        </button>
                    </div>
                </form>
            </div>

            <!-- Coluna do Hist√≥rico de Inspe√ß√µes -->
            <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Hist√≥rico de Inspe√ß√µes</h2>
                    <div class="flex items-center gap-2">
                         <button id="sort-history-btn" class="text-sm font-bold py-2 px-3 rounded-lg border hover:bg-gray-100 transition-colors" title="Ordenar por Data">üìÖ</button>
                         <button id="clear-history-btn" class="bg-red-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Limpar Tudo</button>
                    </div>
                </div>
                <div id="history-container" class="space-y-4">
                    <p id="no-history-message" class="text-center text-gray-500 py-10">Nenhuma inspe√ß√£o registrada ainda.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Gerenciamento de Equipamentos -->
    <div id="equipment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md modal-content"><div class="p-6 border-b flex justify-between items-center"><h3 class="text-xl font-semibold text-gray-800">Gerenciar Equipamentos</h3><button id="close-equipment-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div class="p-6 overflow-y-auto"><ul id="equipment-list" class="space-y-2 mb-6"></ul><form id="add-equipment-form" class="flex gap-2"><input type="text" id="new-equipment-name" class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500" placeholder="Nome do novo equipamento" required><button type="submit" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Adicionar</button></form></div></div>
    </div>

    <!-- Modal de Notifica√ß√£o -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 transition-opacity duration-300"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center transform scale-95 transition-transform duration-300"><p id="notification-message" class="text-lg text-gray-800"></p></div></div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <h3 id="confirm-title" class="text-lg font-semibold text-gray-800 mb-2"></h3>
                <p id="confirm-message" class="text-gray-600 mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-btn-cancel" class="px-6 py-2 rounded-lg border hover:bg-gray-100">Cancelar</button>
                    <button id="confirm-btn-ok" class="px-6 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Constantes e Vari√°veis de Estado
            const INSPECTIONS_STORAGE_KEY = 'inspections';
            const EQUIPMENT_STORAGE_KEY = 'inspection_equipment';
            let capturedImageBase64 = null;
            let sortOrder = 'desc'; // 'desc' para mais novo, 'asc' para mais antigo

            // Elementos do DOM
            const form = document.getElementById('inspection-form');
            const historyContainer = document.getElementById('history-container');
            const noHistoryMessage = document.getElementById('no-history-message');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const sortHistoryBtn = document.getElementById('sort-history-btn');
            const notificationModal = document.getElementById('notification-modal');
            const notificationMessage = document.getElementById('notification-message');
            const equipmentSelect = document.getElementById('equipment-select');
            const cameraInput = document.getElementById('camera-input');
            const imagePreview = document.getElementById('image-preview');
            const equipmentModal = document.getElementById('equipment-modal');
            const manageEquipmentBtn = document.getElementById('manage-equipment-btn');
            const closeEquipmentModalBtn = document.getElementById('close-equipment-modal-btn');
            const addEquipmentForm = document.getElementById('add-equipment-form');
            const newEquipmentNameInput = document.getElementById('new-equipment-name');
            const equipmentListUl = document.getElementById('equipment-list');
            const vazamentoGeralRadios = document.querySelectorAll('input[name="vazamento_geral"]');
            const vazamentoDetailsContainer = document.getElementById('vazamento-details-container');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmBtnOk = document.getElementById('confirm-btn-ok');
            const confirmBtnCancel = document.getElementById('confirm-btn-cancel');
            
            // --- Fun√ß√µes de Notifica√ß√£o e Confirma√ß√£o ---
            const showNotification = (message, duration = 2000) => {
                notificationMessage.textContent = message;
                notificationModal.classList.remove('hidden');
                setTimeout(() => {
                    notificationModal.classList.add('opacity-100');
                    notificationModal.querySelector('div').classList.add('scale-100');
                }, 10);
                setTimeout(() => {
                    notificationModal.classList.remove('opacity-100');
                    notificationModal.querySelector('div').classList.remove('scale-100');
                    setTimeout(() => notificationModal.classList.add('hidden'), 300);
                }, duration);
            };

            const showConfirmation = (title, message, onConfirm) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmModal.classList.remove('hidden');

                const newOkBtn = confirmBtnOk.cloneNode(true);
                confirmBtnOk.parentNode.replaceChild(newOkBtn, confirmBtnOk);

                const newCancelBtn = confirmBtnCancel.cloneNode(true);
                confirmBtnCancel.parentNode.replaceChild(newCancelBtn, confirmBtnCancel);
                
                newOkBtn.addEventListener('click', () => {
                    onConfirm();
                    confirmModal.classList.add('hidden');
                });
                newCancelBtn.addEventListener('click', () => {
                    confirmModal.classList.add('hidden');
                });
            };

            // --- Gerenciamento de Dados (com tratamento de erros) ---
            const getFromStorage = (key) => {
                try {
                    return JSON.parse(localStorage.getItem(key)) || [];
                } catch (e) {
                    console.error(`Erro ao ler do localStorage (${key}):`, e);
                    showNotification("Erro: N√£o foi poss√≠vel ler os dados salvos.");
                    return [];
                }
            };
            const saveToStorage = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Erro ao salvar no localStorage (${key}):`, e);
                    showNotification("Erro: N√£o foi poss√≠vel salvar os dados.");
                }
            };

            // --- Gerenciamento de Equipamentos ---
            const populateEquipmentSelect = () => {
                const equipments = getFromStorage(EQUIPMENT_STORAGE_KEY);
                equipmentSelect.innerHTML = '<option value="">-- Escolha um equipamento --</option>';
                equipments.forEach(eq => {
                    const option = new Option(eq, eq);
                    equipmentSelect.appendChild(option);
                });
            };
            const renderEquipmentListModal = () => {
                const equipments = getFromStorage(EQUIPMENT_STORAGE_KEY);
                equipmentListUl.innerHTML = equipments.length ? '' : '<li class="text-center text-gray-500">Nenhum equipamento cadastrado.</li>';
                equipments.forEach((eq, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg';
                    li.innerHTML = `<span class="text-gray-800">${eq}</span><button data-index="${index}" class="remove-equipment-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>`;
                    equipmentListUl.appendChild(li);
                });
            };
            const initializeEquipment = () => {
                if (getFromStorage(EQUIPMENT_STORAGE_KEY).length === 0) {
                    saveToStorage(EQUIPMENT_STORAGE_KEY, ["3321.BBA 0001", "Bomba Centr√≠fuga BC-101", "Motor El√©trico ME-250", "Compressor de Ar CA-30"]);
                }
                populateEquipmentSelect();
            };

            // --- Hist√≥rico de Inspe√ß√£o ---
            const getOverallStatus = (checklist) => {
                if (Object.values(checklist).some(status => status === 'Cr√≠tico')) return { text: 'Cr√≠tico', class: 'border-red-500' };
                if (Object.values(checklist).some(status => status === 'Aten√ß√£o')) return { text: 'Aten√ß√£o', class: 'border-yellow-500' };
                return { text: 'OK', class: 'border-green-500' };
            };

            const renderHistory = () => {
                const inspections = getFromStorage(INSPECTIONS_STORAGE_KEY);
                historyContainer.innerHTML = ''; 

                if (inspections.length === 0) {
                    historyContainer.appendChild(noHistoryMessage);
                    noHistoryMessage.style.display = 'block';
                } else {
                    noHistoryMessage.style.display = 'none';
                    inspections.sort((a, b) => {
                        const dateA = new Date(a.timestamp);
                        const dateB = new Date(b.timestamp);
                        return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                    });

                    inspections.forEach(inspection => {
                        const overallStatus = getOverallStatus(inspection.checklist);
                        const entry = document.createElement('details');
                        entry.className = `bg-white rounded-lg border-l-4 shadow-sm transition-all hover:shadow-md ${overallStatus.class} overflow-hidden`;

                        const statusClasses = { 'OK': 'status-ok', 'Aten√ß√£o': 'status-atencao', 'Cr√≠tico': 'status-critico' };
                        const checklistHTML = Object.entries(inspection.checklist)
                            .filter(([item]) => item !== 'vazamento_geral')
                            .map(([item, status]) => {
                                let displayName = item.replace(/_/g, ' ').replace('vazamento ', '').replace('tipo ', '');
                                displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                                return `<div class="flex justify-between items-center text-sm"><span class="text-gray-600">${displayName}:</span><span class="font-semibold px-2 py-1 text-xs rounded-full ${statusClasses[status] || 'bg-gray-200'}">${status}</span></div>`;
                        }).join('');
                        
                        const imageHTML = inspection.imageData ? `<div class="mt-3 pt-3 border-t"><h5 class="font-semibold text-sm mb-2">Foto Registrada:</h5><img src="${inspection.imageData}" class="rounded-lg shadow-md max-w-xs mx-auto" alt="Foto da inspe√ß√£o"></div>` : '';
                        const obsHTML = inspection.observations ? `<div class="mt-3 pt-3 border-t"><p class="text-sm text-gray-700"><strong class="font-semibold">Obs:</strong> ${inspection.observations}</p></div>` : '';

                        entry.innerHTML = `
                            <summary class="p-4 cursor-pointer flex justify-between items-center gap-2">
                                <div class="flex-grow"><h4 class="font-bold text-lg text-gray-800">${inspection.equipment}</h4><span class="text-sm font-medium text-gray-500">${new Date(inspection.timestamp).toLocaleString('pt-BR')}</span></div>
                                <button data-id="${inspection.id}" class="delete-inspection-btn text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-100 transition-colors text-2xl leading-none flex-shrink-0 w-8 h-8 flex items-center justify-center">&times;</button>
                            </summary>
                            <div class="p-4 border-t border-gray-200 bg-gray-50">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">${checklistHTML}</div>
                                ${obsHTML}
                                ${imageHTML}
                            </div>`;
                        historyContainer.appendChild(entry);
                    });
                }
            };
            
            // --- Resetar Formul√°rio ---
            const resetForm = () => {
                form.reset();
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                capturedImageBase64 = null;
                cameraInput.value = ''; 
                document.querySelector('input[name="vazamento_geral"][value="OK"]').checked = true;
                toggleLeakDetails(false);
            };

            // --- L√≥gica de Vazamento ---
            const toggleLeakDetails = (enable) => {
                const inputs = vazamentoDetailsContainer.querySelectorAll('input[type="radio"]');
                if (enable) {
                    vazamentoDetailsContainer.classList.remove('opacity-50', 'pointer-events-none');
                    inputs.forEach(input => input.disabled = false);
                } else {
                    vazamentoDetailsContainer.classList.add('opacity-50', 'pointer-events-none');
                    inputs.forEach(input => {
                        input.disabled = true;
                        input.checked = false;
                    });
                }
            };
            
            // --- Event Listeners ---
            manageEquipmentBtn.addEventListener('click', () => { renderEquipmentListModal(); equipmentModal.classList.remove('hidden'); });
            closeEquipmentModalBtn.addEventListener('click', () => equipmentModal.classList.add('hidden'));

            addEquipmentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = newEquipmentNameInput.value.trim();
                if (newName) {
                    const equipments = getFromStorage(EQUIPMENT_STORAGE_KEY);
                    if (equipments.includes(newName)) {
                        showNotification('Este equipamento j√° existe.');
                    } else {
                        equipments.push(newName);
                        saveToStorage(EQUIPMENT_STORAGE_KEY, equipments);
                        populateEquipmentSelect();
                        renderEquipmentListModal();
                        newEquipmentNameInput.value = '';
                        showNotification('Equipamento adicionado!');
                    }
                }
            });

            equipmentListUl.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-equipment-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    let equipments = getFromStorage(EQUIPMENT_STORAGE_KEY);
                    equipments.splice(index, 1);
                    saveToStorage(EQUIPMENT_STORAGE_KEY, equipments);
                    populateEquipmentSelect();
                    renderEquipmentListModal();
                    showNotification('Equipamento removido.');
                }
            });
            
            vazamentoGeralRadios.forEach(radio => radio.addEventListener('change', (e) => toggleLeakDetails(e.target.value === 'Verificar')));

            cameraInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        capturedImageBase64 = e.target.result;
                        imagePreview.src = capturedImageBase64;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!equipmentSelect.value) { showNotification('Por favor, selecione um equipamento.'); return; }

                const checklistData = {};
                let allItemsChecked = true;

                const sectionsToValidate = ['vibra√ß√£o', 'ru√≠do', 'temperatura', 'fixa√ß√£o', 'limpeza', 'vazamento_geral'];
                for (const itemName of sectionsToValidate) {
                    const checkedRadio = document.querySelector(`input[name="${itemName}"]:checked`);
                    if (checkedRadio) checklistData[itemName] = checkedRadio.value;
                    else { allItemsChecked = false; break; }
                }

                if (allItemsChecked && checklistData['vazamento_geral'] === 'Verificar') {
                    const leakSections = ['tipo_fluido', 'vazamento_gaxeta', 'vazamento_selo', 'vazamento_tubula√ß√£o', 'vazamento_juntas', 'vazamento_flanges', 'vazamento_conex√µes'];
                    for (const itemName of leakSections) {
                        const checkedRadio = document.querySelector(`input[name="${itemName}"]:checked`);
                        if (checkedRadio) checklistData[itemName] = checkedRadio.value;
                        else { allItemsChecked = false; break; }
                    }
                }
                
                if (!allItemsChecked) { showNotification('Por favor, preencha todos os itens obrigat√≥rios.'); return; }

                const newInspection = {
                    id: Date.now(),
                    equipment: equipmentSelect.value,
                    checklist: checklistData,
                    observations: document.getElementById('observations').value,
                    imageData: capturedImageBase64,
                    timestamp: new Date().toISOString(),
                };

                const inspections = getFromStorage(INSPECTIONS_STORAGE_KEY);
                inspections.push(newInspection);
                saveToStorage(INSPECTIONS_STORAGE_KEY, inspections);
                
                showNotification('Inspe√ß√£o salva com sucesso!');
                renderHistory();
                resetForm();
            });
            
            historyContainer.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-inspection-btn');
                if (deleteButton) {
                    e.preventDefault();
                    const idToDelete = parseInt(deleteButton.dataset.id, 10);
                    showConfirmation('Excluir Inspe√ß√£o', 'Deseja realmente excluir esta inspe√ß√£o?', () => {
                        let inspections = getFromStorage(INSPECTIONS_STORAGE_KEY);
                        inspections = inspections.filter(insp => insp.id !== idToDelete);
                        saveToStorage(INSPECTIONS_STORAGE_KEY, inspections);
                        renderHistory();
                        showNotification('Inspe√ß√£o exclu√≠da.');
                    });
                }
            });
            
            sortHistoryBtn.addEventListener('click', () => {
                sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
                renderHistory();
                showNotification(`Ordenado por data ${sortOrder === 'desc' ? 'mais recente' : 'mais antiga'}.`);
            });

            clearHistoryBtn.addEventListener('click', () => {
                showConfirmation('Limpar Hist√≥rico', 'Voc√™ tem certeza que deseja apagar TODO o hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita.', () => {
                    saveToStorage(INSPECTIONS_STORAGE_KEY, []);
                    renderHistory();
                    showNotification('Hist√≥rico de inspe√ß√µes foi limpo.');
                });
            });

            // --- Inicializa√ß√£o ---
            initializeEquipment();
            renderHistory();
            resetForm(); 
        });
    </script>
</body>
</html>